name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  BOOST_VERSION: 1.82.0

jobs:
  build-and-test:
    name: ${{ matrix.os }} - ${{ matrix.compiler }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux - GCC
          - os: ubuntu-22.04
            compiler: gcc
            cc: gcc-11
            cxx: g++-11
            
          - os: ubuntu-22.04
            compiler: gcc
            cc: gcc-12
            cxx: g++-12

          # Linux - Clang
          - os: ubuntu-22.04
            compiler: clang
            cc: clang-14
            cxx: clang++-14
            
          - os: ubuntu-22.04
            compiler: clang
            cc: clang-15
            cxx: clang++-15

          # macOS
          - os: macos-13
            compiler: clang
            cc: clang
            cxx: clang++
            
          - os: macos-14
            compiler: clang
            cc: clang
            cxx: clang++

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          libssl-dev \
          libboost-all-dev \
          ${{ matrix.cxx }}

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake ninja openssl@3 boost

    - name: Set up environment
      run: |
        echo "CC=${{ matrix.cc }}" >> $GITHUB_ENV
        echo "CXX=${{ matrix.cxx }}" >> $GITHUB_ENV

    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DBUILD_TESTS=ON \
          -DCMAKE_C_COMPILER=${{ matrix.cc }} \
          -DCMAKE_CXX_COMPILER=${{ matrix.cxx }}

    - name: Build
      run: cmake --build build --parallel

    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure --parallel

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.compiler }}
        path: build/test-results/
        if-no-files-found: ignore

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-tidy-15 \
          cppcheck \
          libssl-dev \
          libboost-all-dev

    - name: Run cppcheck
      run: |
        cppcheck --enable=all --inconclusive --std=c++23 \
          --suppress=missingIncludeSystem \
          --suppress=unmatchedSuppression \
          -I include/ src/ 2>&1 | tee cppcheck-report.txt

    - name: Upload static analysis results
      uses: actions/upload-artifact@v4
      with:
        name: static-analysis-results
        path: cppcheck-report.txt

  sanitizers:
    name: Sanitizers - ${{ matrix.sanitizer }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        sanitizer: [address, undefined, thread]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          clang-15 \
          libssl-dev \
          libboost-all-dev

    - name: Configure with sanitizer
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=clang-15 \
          -DCMAKE_CXX_COMPILER=clang++-15 \
          -DCMAKE_CXX_FLAGS="-fsanitize=${{ matrix.sanitizer }} -fno-omit-frame-pointer" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=${{ matrix.sanitizer }}" \
          -DBUILD_TESTS=ON

    - name: Build
      run: cmake --build build --parallel

    - name: Run tests with sanitizer
      working-directory: build
      run: ctest --output-on-failure
      env:
        ASAN_OPTIONS: detect_leaks=1:check_initialization_order=1
        UBSAN_OPTIONS: print_stacktrace=1
        TSAN_OPTIONS: second_deadlock_stack=1

  docker:
    name: Docker Build
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: tor_relay:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

  coverage:
    name: Code Coverage
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          gcc-12 \
          g++-12 \
          lcov \
          libssl-dev \
          libboost-all-dev

    - name: Configure with coverage
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=gcc-12 \
          -DCMAKE_CXX_COMPILER=g++-12 \
          -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage" \
          -DBUILD_TESTS=ON

    - name: Build
      run: cmake --build build --parallel

    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure

    - name: Generate coverage report
      run: |
        lcov --capture --directory build --output-file coverage.info
        lcov --remove coverage.info '/usr/*' '*/tests/*' '*/_deps/*' --output-file coverage.info
        lcov --list coverage.info

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: coverage.info
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

  build-status:
    name: Build Status
    runs-on: ubuntu-22.04
    needs: [build-and-test, static-analysis, sanitizers, docker, coverage]
    if: always()
    steps:
    - name: Check build status
      run: |
        if [[ "${{ needs.build-and-test.result }}" == "success" && \
              "${{ needs.static-analysis.result }}" == "success" && \
              "${{ needs.sanitizers.result }}" == "success" && \
              "${{ needs.docker.result }}" == "success" ]]; then
          echo "✅ All CI checks passed!"
          exit 0
        else
          echo "❌ Some CI checks failed"
          exit 1
        fi
